<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ProtoForge</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; height: 100vh; overflow: hidden; }
    .container { display: flex; height: 100vh; max-width: 1400px; margin: 0 auto; background: #fff; box-shadow: 0 0 30px rgba(0,0,0,0.08); }
    
    /* Chat Panel */
    .chat-panel { flex: 1; display: flex; flex-direction: column; min-width: 400px; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px; }
    .message { display: flex; gap: 12px; max-width: 85%; }
    .message.user { align-self: flex-end; flex-direction: row-reverse; }
    .avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; flex-shrink: 0; }
    .message.user .avatar { background: #007aff; color: #fff; }
    .message.assistant .avatar { background: #34c759; color: #fff; }
    .bubble { padding: 14px 18px; border-radius: 18px; font-size: 14px; line-height: 1.6; }
    .message.user .bubble { background: #007aff; color: #fff; border-bottom-right-radius: 4px; }
    .message.assistant .bubble { background: #f0f0f0; color: #333; border-bottom-left-radius: 4px; }
    .bubble ul { margin: 10px 0 0 18px; }
    .bubble li { margin-bottom: 6px; }
    
    /* Input Area */
    .input-area { padding: 20px 24px; background: #fff; border-top: 1px solid #eee; }
    .input-wrapper { display: flex; gap: 12px; align-items: flex-end; }
    .chat-input { flex: 1; padding: 14px 18px; border: 1px solid #ddd; border-radius: 24px; font-size: 14px; resize: none; outline: none; font-family: inherit; max-height: 120px; }
    .chat-input:focus { border-color: #007aff; }
    .send-btn { width: 48px; height: 48px; border-radius: 50%; background: #007aff; color: #fff; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .send-btn:hover { background: #0056b3; transform: scale(1.05); }
    .send-btn:disabled { background: #ccc; transform: none; cursor: not-allowed; }
    .options { display: flex; gap: 10px; margin-top: 12px; }
    .options select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 13px; background: #fff; cursor: pointer; }
    
    /* Progress */
    .progress { padding: 0 24px 16px; display: none; }
    .progress.active { display: block; }
    .progress-bar { height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #007aff, #34c759); border-radius: 3px; transition: width 0.3s; }
    .progress-text { font-size: 12px; color: #666; margin-top: 6px; text-align: center; }
    
    /* Right Panel */
    .output-panel { width: 380px; background: #fafafa; border-left: 1px solid #eee; display: flex; flex-direction: column; }
    .tabs { display: flex; border-bottom: 1px solid #eee; background: #fff; }
    .tab { flex: 1; padding: 14px; font-size: 13px; font-weight: 500; color: #666; border: none; background: none; cursor: pointer; position: relative; }
    .tab:hover { color: #333; }
    .tab.active { color: #007aff; }
    .tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: #007aff; }
    .content { flex: 1; overflow-y: auto; padding: 16px; }
    .panel { display: none; }
    .panel.active { display: block; }
    
    /* Files */
    .file-item { padding: 10px 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .file-item:hover { background: #f0f0f0; }
    .file-item.selected { background: #e8f2ff; color: #007aff; }
    .file-item.folder { font-weight: 500; }
    
    /* Code */
    .code-section { margin-bottom: 12px; }
    .code-filename { font-size: 12px; color: #666; margin-bottom: 6px; }
    .code-block { background: #f8f9fa; border: 1px solid #eee; border-radius: 8px; padding: 12px; font-family: 'SF Mono', Monaco, monospace; font-size: 12px; white-space: pre-wrap; max-height: 150px; overflow-y: auto; }
    
    /* Status Bar */
    .status-bar { padding: 10px 24px; background: #fff; border-top: 1px solid #eee; display: flex; justify-content: space-between; font-size: 12px; color: #666; }
    
    /* Welcome */
    .welcome { text-align: center; padding: 40px; color: #666; }
    .welcome h2 { font-size: 18px; color: #333; margin-bottom: 10px; }
    .suggestions { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 20px; }
    .chip { padding: 8px 16px; background: #f0f0f0; border-radius: 20px; font-size: 13px; cursor: pointer; transition: all 0.2s; }
    .chip:hover { background: #e0e0e0; }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    
    /* Typing */
    .typing { display: flex; gap: 4px; padding: 12px 16px; }
    .dot { width: 8px; height: 8px; background: #999; border-radius: 50%; animation: typing 1.4s infinite; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }
  </style>
</head>
<body>
  <div class="container">
    <div class="chat-panel">
      <div class="chat-messages" id="messages">
        <div class="welcome" id="welcome">
          <h2>What would you like to build?</h2>
          <p>Describe your prototype idea and I'll generate everything you need.</p>
          <div class="suggestions">
            <div class="chip" onclick="setPrompt('A smart plant monitor with moisture sensor')">üå± Smart plant monitor</div>
            <div class="chip" onclick="setPrompt('Weather station with ESP32')">üå§Ô∏è ESP32 weather station</div>
            <div class="chip" onclick="setPrompt('IoT dashboard for sensors')">üìä IoT dashboard</div>
            <div class="chip" onclick="setPrompt('Bluetooth LE sensor logger')">üì° BLE sensor logger</div>
          </div>
        </div>
      </div>
      <div class="progress" id="progress"><div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div><div class="progress-text" id="progressText">Generating...</div></div>
      <div class="input-area">
        <div class="input-wrapper">
          <textarea class="chat-input" id="input" rows="1" placeholder="Describe your prototype..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();generate();}"></textarea>
          <button class="send-btn" id="sendBtn" onclick="generate()">‚Üí</button>
        </div>
        <div class="options">
          <select id="type"><option value="hybrid">Hybrid</option><option value="hardware">Hardware</option><option value="software">Software</option></select>
          <select id="provider"><option value="ollama">Ollama</option><option value="openai">OpenAI</option><option value="groq">Groq</option><option value="anthropic">Claude</option></select>
        </div>
      </div>
    </div>
    <div class="output-panel">
      <div class="tabs">
        <div class="tab active" onclick="switchTab('files')">Files</div>
        <div class="tab" onclick="switchTab('code')">Code</div>
        <div class="tab" onclick="switchTab('bom')">BOM</div>
        <div class="tab" onclick="switchTab('guide')">Guide</div>
      </div>
      <div class="content">
        <div class="panel active" id="panel-files">
          <div id="files" style="color: #999; text-align: center; padding: 40px;">No project yet. Start chatting!</div>
        </div>
        <div class="panel" id="panel-code">
          <div id="code" style="color: #999; text-align: center; padding: 40px;">Select a file to view code</div>
        </div>
        <div class="panel" id="panel-bom">
          <div id="bom" style="color: #999; text-align: center; padding: 40px;">Bill of Materials will appear here</div>
        </div>
        <div class="panel" id="panel-guide">
          <div id="guide" style="color: #999; text-align: center; padding: 40px;">Build guide will appear here</div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    let projectPath = null, prototype = null, generating = false;
    mermaid.initialize({startOnLoad:true});
    function setPrompt(t){document.getElementById('input').value=t;}
    function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
    function addMsg(role,html){
      const m=document.createElement('div');m.className='message '+role;
      m.innerHTML='<div class="avatar">'+(role==='user'?'U':'AI')+'</div><div class="bubble">'+html+'</div>';
      document.getElementById('messages').appendChild(m);document.getElementById('messages').scrollTop=document.getElementById('messages').scrollHeight;
    }
    async function generate(){
      const d=document.getElementById('input').value,t=document.getElementById('type').value,p=document.getElementById('provider').value;
      if(!d.trim()||generating)return;
      document.getElementById('welcome')?.remove();
      generating=true;document.getElementById('sendBtn').disabled=true;
      addMsg('user',d);
      const typing=document.createElement('div');typing.className='message assistant';typing.id='typing';typing.innerHTML='<div class="avatar">AI</div><div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
      document.getElementById('messages').appendChild(typing);document.getElementById('messages').scrollTop=document.getElementById('messages').scrollHeight;
      try{
        const res=await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({description:d,type:t,provider:p})});
        const data=await res.json();
        document.getElementById('typing').remove();
        if(data.success){projectPath=data.outputDir;prototype=data.prototype;addMsg('assistant',formatResp(data.prototype));await loadFiles();}
        else throw new Error(data.error);
      }catch(e){document.getElementById('typing').remove();addMsg('assistant','Error: '+e.message);}
      generating=false;document.getElementById('sendBtn').disabled=false;document.getElementById('input').value='';
    }
    function formatResp(p){let h='<strong>'+(p.overview?.projectName||'Untitled')+'</strong><br><br>';h+=p.overview?.description||'';h+='<br><br><strong>Type:</strong> '+(p.type||'hybrid');h+='<br><br><strong>Files:</strong><ul>';(p.codeSnippets||[]).forEach(f=>h+='<li>'+f.filename+'</li>');h+='</ul>';return h;}
    async function loadFiles(){const name=projectPath.split('/').pop();const r=await fetch('/api/project/'+name+'/tree');const data=await r.json();let html='';for(const e of (data.entries||[])){if(e.type==='dir'){html+='<div class="file-item folder" onclick="toggleDir(\''+e.name+'\')">üìÅ '+e.name+'</div><div id="dir-'+e.name+'" style="display:none;padding-left:16px;"></div>'}else{html+='<div class="file-item" onclick="openFile(\''+e.name+'\')">üìÑ '+e.name+'</div>'}}document.getElementById('files').innerHTML=html;}
    async function openFile(name){document.querySelectorAll('.file-item').forEach(i=>i.classList.remove('selected'));event.target.classList.add('selected');switchTab('code');const r=await fetch('/api/project/'+projectPath.split('/').pop()+'/file?path='+encodeURIComponent(name));const d=await r.json();document.getElementById('code').innerHTML='<div class="code-section"><div class="code-filename">'+esc(name)+'</div><div class="code-block">'+esc(d.content?.slice(0,2000)||'')+'</div></div>';}
    function switchTab(tab){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));event.target.classList.add('active');document.getElementById('panel-'+tab).classList.add('active');}
  </script>
</body>
</html>
